<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.w3.org/1999/xhtml">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Modernize Free</title>
    <link rel="shortcut icon" type="image/png" href="../assets/images/logos/favicon.png"/>
    <link rel="stylesheet" href="/assets/css/styles.min.css"/>
</head>

<body>
<!--  Body Wrapper -->
<div class="page-wrapper" id="main-wrapper" data-layout="vertical" data-navbarbg="skin6" data-sidebartype="full"
     data-sidebar-position="fixed" data-header-position="fixed">
    <div>
        <th:block th:replace="Admin/management::aside"></th:block>
    </div>
    <div class="body-wrapper">
        <div>
            <th:block th:replace="Admin/management::header"></th:block>
        </div>
        <div class="container-fluid">
            <div class="container-fluid">
                <div class="card">
                    <div class="card-body">
                        <div class="row">
                            <!-- Form lọc phim -->
                            <div class="list-movie-filter SearchMovies">
                                <div class="list-movie-filter-main">
                                    <form id="form-filter"
                                          class="form-inline d-flex justify-content-between align-items-center"
                                          method="GET" action="/movies">
                                        <!-- Sắp xếp -->
                                        <div class="list-movie-filter-item Form-Group me-3">
                                            <label style="color: dark" class="AAIco-tune d-flex align-items-center">
                                                <i class="bi bi-filter-left me-2"></i> Sắp xếp
                                            </label>
                                            <div class="w-100">
                                                <select id="filter-sort" name="sort" class="form-select">
                                                    <option value="desc" th:selected="${sort == 'desc'}">Mới nhất
                                                    </option>
                                                    <option value="asc" th:selected="${sort == 'asc'}">Cũ nhất</option>
                                                </select>
                                            </div>
                                        </div>

                                        <!-- Danh mục -->
                                        <div class="list-movie-filter-item Form-Group me-3">
                                            <label style="color: dark" class="AAIco-widgets d-flex align-items-center">
                                                <i class="bi bi-card-list me-2"></i> Danh mục
                                            </label>
                                            <div class="w-100">
                                                <select id="filter-eptype" name="cat" class="form-select">
                                                    <option value="" th:selected="${cat == null or cat == ''}">Tất cả
                                                    </option>
                                                    <option value="phimle" th:selected="${cat == 'phimle'}">Phim Lẻ
                                                    </option>
                                                    <option value="phimbo" th:selected="${cat == 'phimbo'}">Phim Bộ
                                                    </option>
                                                </select>
                                            </div>
                                        </div>

                                        <!-- Thể loại -->
                                        <div class="list-movie-filter-item Form-Group me-3">
                                            <label style="color: dark"
                                                   class="AAIco-movie_creation d-flex align-items-center">
                                                <i class="bi bi-tags me-2"></i> Thể loại
                                            </label>
                                            <div class="w-100">
                                                <select id="filter-category" name="genreIds" class="form-select">
                                                    <option value="">Tất cả</option>
                                                    <th:block th:each="genre : ${genres}">
                                                        <option th:value="${genre.genreId}"
                                                                th:selected="${genreIds != null and genreIds.contains(genre.genreId)}"
                                                                th:text="${genre.genreName} + ' (' + ${genre.movieCount} + ')'"></option>
                                                        <!-- Giả sử bạn có biến movieCount -->
                                                    </th:block>
                                                </select>
                                            </div>
                                        </div>

                                        <!-- Quốc gia -->
                                        <div class="list-movie-filter-item Form-Group me-3">
                                            <label style="color: dark" class="AAIco-widgets d-flex align-items-center">
                                                <i class="bi bi-flag me-2"></i> Quốc gia
                                            </label>
                                            <div class="w-100">
                                                <select id="countrySelect" name="countryIds" class="form-select">
                                                    <option value="">Tất cả</option>
                                                    <th:block th:each="country : ${countries}">
                                                        <option th:value="${country.countryId}"
                                                                th:selected="${countryIds != null and countryIds.contains(country.countryId)}"
                                                                th:text="${country.countryName} + ' (' + ${country.movieCount} + ')'"></option>
                                                    </th:block>
                                                </select>
                                            </div>
                                        </div>

                                        <!-- Năm phát hành -->
                                        <div class="list-movie-filter-item Form-Group me-3">
                                            <label style="color: dark" class="AAIco-widgets d-flex align-items-center">
                                                <i class="bi bi-calendar me-2"></i> Năm
                                            </label>
                                            <div class="w-100">
                                                <select id="releaseYearSelect" name="releaseYear" class="form-select">
                                                    <option value="">Tất cả</option>
                                                    <th:block th:each="year : ${releaseYears}">
                                                        <option th:value="${year}"
                                                                th:selected="${year == releaseYear}"
                                                                th:text="${year}"></option>
                                                    </th:block>
                                                </select>
                                            </div>
                                        </div>
                                        <div class="list-movie-filter-item Form-Group me-3">
                                            <label style="color: dark" class="AAIco-widgets d-flex align-items-center">
                                                <i class="bi bi-calendar me-2"></i> Trạng thái
                                            </label>
                                            <select id="status" name="status" class="form-select">
                                                <option value="" th:selected="${status == null or status == ''}">Tất cả</option>
                                                <option value="Sắp Chiếu" th:selected="${status == 'Sắp Chiếu'}">Sắp chiếu</option>
                                                <option value="Đang Chiếu" th:selected="${status == 'Đang Chiếu'}">Đang chiếu</option>
                                                <option value="Hoàn Tất" th:selected="${status == 'Hoàn Tất'}">Hoàn tất</option>
                                            </select>
                                        </div>

                                        <div class="button">
                                            <button class="btn btn-success mt-3" type="submit" id="btn-movie-filter">
                                                <i class="bi bi-search me-2"></i> Lọc phim
                                            </button>
                                        </div>
                                    </form>
                                </div>
                            </div>
                        </div>


                        <!-- ***** Banner End ***** -->

                        <!-- ***** Most Popular Start ***** -->
                        <div class="most-popular">
                            <div class="row">
                                <div class="col-lg-12">
                                    <div class="row">
                                        <div class="container my-5">
                                            <div class="d-flex justify-content-between align-items-center mb-3"> <!-- Tạo hàng linh hoạt -->
                                                <!-- Nút Thêm Phim Mới -->
                                                <a href="/movies/add" class="btn btn-success">Thêm Phim Mới</a>

                                                <!-- Form tìm kiếm -->
                                                <form class="d-flex" action="/movies/adminsearch" method="GET"> <!-- Thay đổi action nếu cần -->
                                                    <input type="text" id="searchText" name="keyword" class="form-control me-2" placeholder="Tìm kiếm phim..." aria-label="Search">
                                                    <button type="submit" class="btn btn-primary"><i class="ti ti-search"></i></button>
                                                </form>
                                            </div>
                                            <table class="table table-striped table-hover">
                                                <thead class="table-dark">
                                                <tr>
                                                    <th scope="col">Thông tin</th>
                                                    <th scope="col">Poster</th>
                                                    <th scope="col">Thể loại</th>
                                                    <th scope="col">Quốc gia</th>
                                                    <th scope="col">Các tập</th>
                                                    <th scope="col">Hành động</th>
                                                </tr>
                                                </thead>
                                                <tbody>
                                                <tr th:each="movie : ${moviePage.content}">
                                                    <td style="max-width: 200px;">
                                                        <div>
                                                            <!-- Phần tiêu đề và năm -->
                                                            <div class="movie-details">
                                                                <div class="movie-title">
                                                                    <span class="text-primary d-inline" th:text="${movie.title}"></span>
                                                                    <span class="text-success d-inline" th:text="' [' + ${movie.releaseYear} + ']'"></span>
                                                                </div>
                                                                <div class="text-muted pb-2">
                                                                    <small th:text="${movie.name}"></small>
                                                                </div>
                                                            </div>

                                                            <!-- Modal -->

                                                            <!-- Phần thể loại -->
                                                            <div class="badge bg-secondary font-weight-normal">
                                                                <span th:if="${movie.isSeries}">Phim bộ</span>
                                                                <span th:if="${movie.isSeries != null and not movie.isSeries}">Phim lẻ</span>
                                                            </div>

                                                            <!-- Phần trạng thái -->
                                                            <div th:if="${movie.isSeries}" class="badge"
                                                                 th:class="'badge bg-' + (${movie.status == 'Sắp Chiếu'} ? 'warning' :
                              (${movie.episodes.size() > 0 ? 'success' : 'secondary'}))"
                                                                 th:text="${movie.episodes.size() > 0 ? 'Tập ' + movie.episodes[movie.episodes.size() - 1].episodeNumber + ' / ' + movie.totalEpisodes : 'Sắp Chiếu'}">
                                                            </div>

                                                            <div th:if="${!movie.isSeries}" class="badge"
                                                                 th:class="'badge bg-' + (${movie.status == 'Sắp Chiếu'} ? 'warning' :
                              (${movie.status == 'Đang Chiếu'} ? 'info' :
                              (${movie.status == 'Hoàn Tất'} ? 'success' : 'secondary')))"
                                                                 th:text="${movie.status}">
                                                            </div>




                                                        </div>
                                                    </td>

                                                    <td>
                                                        <img th:src="@{${movie.posterUrl}}" alt="Poster"
                                                             class="img-fluid" width="100">
                                                    </td>
                                                    <td>
                                                        <ul class="genre-list">
                                                            <li th:each="genre : ${movie.genres}"
                                                                th:text="'- ' + ${genre.genreName}"></li>
                                                        </ul>
                                                    </td>
                                                    <td>
                                                        <div class="font-weight-normal">
                                                            <span th:text="${movie.country.countryName}"></span>
                                                        </div>
                                                    </td>

                                                    <td>
                                                        <div>
                                                            <span >
    <!-- Kiểm tra nếu là phim bộ -->
                                                                <a style="width:80px" class="btn btn-secondary btn-sm" th:href="@{/episodes/add(movieId=${movie.movieId})}">Thêm Tập</a>

                                                                <!-- Nút "Xem Tập" với dropdown -->
                                                                <div th:if="${movie.episodes.size() > 0}" class="dropdown">
                                                                    <button style="width:80px" class="btn btn-primary btn-sm dropdown-toggle" type="button" id="dropdownMenuButton"
                                                                            data-bs-toggle="dropdown" aria-expanded="false">
                                                                        Xem Tập
                                                                    </button>
                                                                    <ul class="dropdown-menu" aria-labelledby="dropdownMenuButton" id="episodes-${movie.movieId}" style="max-height: 300px; overflow-y: auto;">
                                                                        <!-- Các tập phim -->
                                                                        <li th:each="episode : ${movie.episodes}" class="d-flex justify-content-between align-items-center">
                                                                            <a class="dropdown-item"
                                                                               th:href="@{/episodes/detail/{id}(id=${episode.episodeId})}"
                                                                               th:text="'Tập ' + ${episode.episodeNumber}"></a>

                                                                            <!-- Nút xóa -->
                                                                            <a class="btn btn-danger btn-sm ms-2"
                                                                               th:href="@{/episodes/delete/{id}(id=${episode.episodeId})}"
                                                                               onclick="return confirm('Bạn có chắc muốn xóa tập này?');">
                                                                               Xóa
                                                                            </a>
                                                                        </li>
                                                                    </ul>
                                                                </div>
                                                            </span>
                                                        </div>
                                                    </td>


                                                    <td>
                                                        <div class="btn-group" role="group">
                                                            <a class="btn btn-primary btn-sm"
                                                               th:href="@{/movies/edit/{id}(id=${movie.movieId})}">Sửa</a>
                                                            <a class="btn btn-danger btn-sm"
                                                               th:href="@{/movies/delete/{id}(id=${movie.movieId})}"
                                                               onclick="return confirm('Bạn có chắc chắn muốn xóa không?');">Xóa</a>
                                                            <a class="btn btn-info btn-sm"
                                                               th:href="@{/movies/detail/{id}(id=${movie.movieId})}">Xem</a>
                                                        </div>
                                                    </td>
                                                </tr>
                                                </tbody>
                                            </table>

                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div th:if="${moviePage.totalPages > 1}">
                                <nav aria-label="Page navigation">
                                    <ul class="pagination justify-content-center">
                                        <!-- Nút "Previous" -->
                                        <li th:if="${moviePage.hasPrevious()}" class="page-item">
                                            <a th:href="@{/movies/adminsearch(page=${moviePage.number - 1}, sort=${sort}, cat=${cat}, genreIds=${genreIds}, actorIds=${actorIds}, countryIds=${countryIds}, releaseYear=${releaseYear}, status=${status},keyword=${keyword} )}"
                                               class="page-link">Previous</a>
                                        </li>

                                        <!-- Trang đầu -->
                                        <li th:classappend="${moviePage.number > 0} ? 'page-item' : 'page-item disabled'">
                                            <a th:href="@{/movies/adminsearch(page=0, sort=${sort}, cat=${cat}, genreIds=${genreIds}, actorIds=${actorIds}, countryIds=${countryIds}, releaseYear=${releaseYear}, status=${status}, keyword=${keyword})}"
                                               class="page-link">1</a>
                                        </li>

                                        <!-- Dấu ba chấm nếu có quá nhiều trang phía trước -->
                                        <li th:if="${moviePage.number > 3}" class="page-item">
                                            <span class="page-link ellipsis">...</span>
                                        </li>

                                        <!-- Các số trang gần trang hiện tại -->
                                        <li th:each="i : ${#numbers.sequence(moviePage.number - 2, moviePage.number + 2)}"
                                            th:if="${i >= 1 && i < moviePage.totalPages - 1}"
                                            th:classappend="${i == moviePage.number} ? 'page-item active' : 'page-item'">
                                            <a th:href="@{/movies/adminsearch(page=${i}, sort=${sort}, cat=${cat}, genreIds=${genreIds}, actorIds=${actorIds}, countryIds=${countryIds}, releaseYear=${releaseYear}, status=${status}, keyword=${keyword})}"
                                               class="page-link" th:text="${i + 1}"></a>
                                        </li>

                                        <!-- Dấu ba chấm nếu có quá nhiều trang phía sau -->
                                        <li th:if="${moviePage.number < moviePage.totalPages - 3}" class="page-item">
                                            <span class="page-link ellipsis">...</span>
                                        </li>

                                        <!-- Trang cuối -->
                                        <li th:classappend="${moviePage.number < moviePage.totalPages - 1} ? 'page-item' : 'page-item disabled'">
                                            <a th:href="@{/movies/adminsearch(page=${moviePage.totalPages - 1}, sort=${sort}, cat=${cat}, genreIds=${genreIds}, actorIds=${actorIds}, countryIds=${countryIds}, releaseYear=${releaseYear}, status=${status},keyword=${keyword})}"
                                               class="page-link" th:text="${moviePage.totalPages}"></a>
                                        </li>

                                        <!-- Nút "Next" -->
                                        <li th:if="${moviePage.hasNext()}" class="page-item">
                                            <a th:href="@{/movies/adminsearch(page=${moviePage.number + 1}, sort=${sort}, cat=${cat}, genreIds=${genreIds}, actorIds=${actorIds}, countryIds=${countryIds}, releaseYear=${releaseYear}, status=${status},keyword=${keyword})}"
                                               class="page-link">Next</a>
                                        </li>
                                    </ul>
                                </nav>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<script src="/assets/libs/jquery/dist/jquery.min.js"></script>
<script src="/assets/libs/bootstrap/dist/js/bootstrap.bundle.min.js"></script>
<script src="/assets/js/sidebarmenu.js"></script>
<script src="/assets/js/app.min.js"></script>
<script src="/assets/libs/simplebar/dist/simplebar.js"></script>
<style>
    .list-movie-filter-item {
    flex: 1; /* Đảm bảo tất cả các mục có cùng chiều ngang */
    width: 200px; /* Chiều rộng tối đa cho mỗi mục */
}
    .form-select::-webkit-scrollbar {
    width: 6px; /* Độ rộng của thanh cuộn */
    height: 6px; /* Chiều cao của thanh cuộn ngang (nếu có) */
}

.form-select::-webkit-scrollbar-thumb {
    background-color: #c4c4c4; /* Màu thanh trượt */
    border-radius: 10px; /* Bo góc thanh trượt */
}
</style>

<script>
    function toggleDropdown(movieId) {
    var episodeList = document.getElementById('episodes-' + movieId);
    var currentDisplay = episodeList.style.display;

    if (currentDisplay === 'none' || currentDisplay === '') {
        episodeList.style.display = 'block';
    } else {
        episodeList.style.display = 'none';
    }
}

<!--// Tự động ẩn dropdown khi click ra ngoài (tuỳ chọn)-->
<!--document.addEventListener('click', function (e) {-->
<!--    var episodeLists = document.querySelectorAll('.dropdown-menu');-->
<!--    episodeLists.forEach(function (menu) {-->
<!--        if (!menu.contains(e.target) && !e.target.closest('.dropdown')) {-->
<!--            menu.style.display = 'none';-->
<!--        }-->
<!--    });-->
<!--});-->
</script>
</body>
</html>
